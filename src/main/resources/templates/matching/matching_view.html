<!DOCTYPE HTML>
<!--
	Slate by Pixelarity
	pixelarity.com | hello@pixelarity.com
	License: pixelarity.com/license
-->
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Fit Hub</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" th:href="@{/assets/css/index.css}" />
  <link rel="stylesheet" th:href="@{/assets/css/sidebar.css}" />
  <noscript><link rel="stylesheet" th:href="@{/assets/css/noscript.css}" /></noscript>

  <!-- Modal -->
  <link rel="stylesheet" th:href="@{/assets/css/matchingModal.css}">

</head>
<style>
  .top_img_box{
      width: 100%;
      height: 310px;
      margin-bottom: 50px;
      background-color: red;
  }

  .top_img_box > img {
      width: 100%;
      height: 100%;
  }

  #main {
      padding: 0;
  }

  .wrapper {
      padding: 0;
      margin-bottom: 100px;
  }

  #header {
      background-color: #5a8100;
  }

  #header nav > ul > li a {
      color: white;
  }

  #header h1 a {
      color: white;
  }

  #header .main ul li > a {
      color: white;

  }

  #footer {
      background-color: #304400;
  }




.write_table{
  border: none;
}
  .write_table tr{
      border-top: none;
      border-bottom: 1px solid gray;
      background-color: white !important;
      height: 50px;
  }
.write_table:hover {
    transform: scale(1.04);
    transition: transform 0.2s;
    box-shadow: 8px 8px 11px rgba(0, 0, 0, 0.3); /* 그림자 효과 추가 */

}

.write_table:active {
    transform: scale(1.04);
}
  .write_table tr:hover{
      background-color: #ebede1 !important;
       transition: transform 0.2s;
  }

.cotent_header{
  font-size: 30px;
  font-weight:bold;
  margin-bottom: 50px;
}
#profileInfo{
width: 350px;
vertical-align: top;
}
#profileInfo img{
max-width: 100%;
    height: auto;
    display: block; /* 이미지 사이에 생기는 여백을 제거하기 위해 추가 */
    margin: auto; /* 이미지를 가운데 정렬하기 위해 추가 */
}
#careerInfo{
width: 700px;
 height: 270px;
}
#careerInfo img{
  margin: auto;
  width: 200px;
 height: 250px;
}
#careerInfo img:hover{
  transform: scale(1.5);
    transition: transform 0.2s;
}
#content_title th{
 padding-top: 20px;
}
.careerPic th{
background-color: white !important;
border-top: none;
border-bottom: 1px solid black;
margin-bottom : 15px;
}
.careerPic tr{
border-top: none;

}
.button_table{

  background-color: white !important;
}
.button_table tr{
  border: none;
  background-color: white !important;
  height: 80px;
}

.button_table tr td a{
 border: 1px solid gray;
 border-radius: 20px;
 padding: 15px;
  box-shadow: 5px 5px 8px rgba(0, 0, 0, 0.3); /* 그림자 효과 추가 */
}
.button_table tr td a:hover{
    background-color: #ebede1 !important;
       transition: transform 0.4s;
       font-weight:bold;
}
#review_userid{
  border:none;
  font-weight: bold;
}
#review_textarea{
margin-top: 20px;
}
.review_result a{
border-radius: 15px;
}
.review_result h4:after{
  border-bottom: none;
}
#finish_button{
  margin-top: 40px;
}






<!-- star rating -->
.rating {
  unicode-bidi: bidi-override;
  direction: rtl;
  text-align: center;
}

.star {
  display: inline-block;
  margin: 0 5px;
  font-size: 24px;
  cursor: pointer;
  color: #ccc;
}

.star.active,
.star:hover {
  color: #ffcc00;
}










<!-- sidebar -->
.DietRanking{
      margin-bottom: 30px;
  }

  .DietRanking_ranking{
      border: 3px solid rgb(103, 145, 18);
  box-sizing: border-box;
  height: 300px;
  }

  .subRanking_ranking{
  border: 3px solid rgb(103, 145, 18);
  box-sizing: border-box;
  height: 300px;
  }
  .side_ranking{
      font-weight: bold;
  }
</style>

<!-- Header -->
<th:block th:replace="~{layout/header::header(${session.loginUser},${session.user})}"></th:block>

<!-- Modal -->
<th:block th:replace="~{layout/matchingModal::matchingModal()}"></th:block>

<!-- Main -->
<section id="main" class="wrapper sidebar left">
  <div class="top_img_box">
    <img src="/images/pic01.jpg" alt="">
  </div>

  <div class="inner">

    <header class="major">
      <h2>트레이너 매칭</h2>
      <p>매칭 글 페이지</p>
    </header>

    <!-- Content -->
    <div class="content">
      <th:block th:if="${list != null and list.size() > 0}" th:each="board : ${list}">
        <div class="cotent_header"><span>[[${trainerInfo.trainerNickname}]]님의 글입니다</span></div>

        <form>
        <!-- 글작성 테이블 -->
        <div>

          <table class="write_table" style="border-collapse: collapse;" border="2">
            <tr>
              <th>제목</th>
              <th>만료일시 : </th>
              <th>[[${board.expirationTime}]]</th>
            </tr>
            <tr>
              <td colspan="3">
                <input type="text" name="boardTitle" size="50" maxlength="50" th:value="${board.boardTitle}" readonly>
              </td>
            </tr>
            <tr>
              <th rowspan="6" id="profileInfo">
                <th:block th:if="${profileInfo != null}">
                  <div style="display:flex; justify-content:center;">
                    <img style="width:100%; height:100%;" th:src="@{/matching/thumbnail (sysName=${profileInfo.sysName})}">
                  </div>
              </th:block></th>
              <th>트레이너</th>
              <th>상담가능시간</th>
            </tr>
            <tr>
              <td>
                [[${trainerInfo.trainerNickname}]]
              </td>
              <td>
                [[${board.availConsultWeeks}]]
                [[${board.availConsultTime}]]
              </td>
            </tr>
            <tr>
              <th>파트</th>
              <th>경력</th>
            </tr>
            <tr>
              <th>[[${trainerInfo.trainerPart}]]</th>
              <th>[[${trainerInfo.trainerCareer}]]</th>
            </tr>
            <tr>
              <th colspan="2" >트레이너 소개</th>
            </tr>
            <tr>
              <th colspan="2" >[[${trainerInfo.trainerIntro}]]</th>
            </tr>
            <tr>
              <th colspan="3">트레이너의 위치</th>
            </tr>
            <tr>
              <th colspan="3">[[${board.trainerAddr}]]</th>
            </tr>
            <tr>
              <th colspan="3">
              <div id="map" style="width:100%;height:350px;"></div>
              <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9d457fe0b04b983671f48d03d84f2fdb&libraries=services"></script>
              <script>
                var mapContainer = document.getElementById('map'), // 지도를 표시할 div
                    mapOption = {
                        center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
                        level: 3 // 지도의 확대 레벨
                    };

                // 지도를 생성합니다
                var map = new kakao.maps.Map(mapContainer, mapOption);

                // 주소-좌표 변환 객체를 생성합니다
                var geocoder = new kakao.maps.services.Geocoder();

                var address = '[[${board.trainerAddr}]]';


                // 주소로 좌표를 검색합니다
                geocoder.addressSearch(address, function(result, status) {

                    // 정상적으로 검색이 완료됐으면
                     if (status === kakao.maps.services.Status.OK) {

                        var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                        // 결과값으로 받은 위치를 마커로 표시합니다
                        var marker = new kakao.maps.Marker({
                            map: map,
                            position: coords
                        });

                        // 인포윈도우로 장소에 대한 설명을 표시합니다
                        var infowindow = new kakao.maps.InfoWindow({
                            content: '<div style="width:150px;text-align:center;padding:6px 0;">[[${trainerInfo.trainerNickname}]]</div>'
                        });
                        infowindow.open(map, marker);

                        // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
                        map.setCenter(coords);
                    }
                });
              </script>
              </th>
            </tr>
            <tr>
              <th colspan="3">내용</th>
            </tr>
            <tr style="height:380px;" id="content_tr">
              <td colspan="3">
                <textarea name="boardContent" style="width:100%;height:350px;resize:none;" readonly>[[${board.boardContent}]]</textarea>
              </td>
            </tr>
          </table>
          <table class="careerPic">
            <tr>
              <th>경력 및 자격 사진</th>
            </tr>
          </table>
          <div>
            <div id="careerInfo">
              <th:block th:if="${careerInfo != null}">
                <img th:src="@{/matching/thumbnail (sysName=${careerInfo.sysName})}">
              </th:block>
            </div>
          </div>
        </div>
      </form>

      <!-- 등록, 목록 버튼 테이블 -->
        <table class="button_table">
          <tr align="right" valign="middle">
            <td>
              <th:block th:if="${board.trainerId == session.loginUser}">
                <form name="boardForm" method="post" th:action="@{/board/remove}">
                <!--  <input name="boardnum" th:value="${board.boardnum}" type="hidden">
                  <input name="pagenum" th:value="${cri.pagenum}" type="hidden">
                  <input name="amount" th:value="${cri.amount}" type="hidden">
                  <input name="type" th:value="${cri.type}" type="hidden">
                  <input name="keyword" th:value="${cri.keyword}" type="hidden">-->
                  <a href="javascript:modify()">수정</a>
                  <a href="javascript:document.boardForm.submit()">삭제</a>
                </form>
              </th:block>
            </td>
          </tr>
          <tr>
            <td>
              <a href="#" class="open" data-trainer-id="${trainerInfo.trainerId}">신청하기</a>
            </td>
            <td>
              <a th:href="${'/matching/matching_list'}">목록</a>
            </td>
          </tr>


        </table>
          <!-- review -->
          <div class="review_line">
            <div id="board" data-board-num="${board.boardNum}"></div>
            <a href="#" class="regist">리뷰 등록</a>
            <div class="reviewForm row">
              <div style="width:25%">
                <h4>작성자</h4>
                <input type="text" id="review_userid" name="userid" th:value="${session.loginUser}" readonly style="text-align: left;">
              </div>
              <div style="width:70%">
                <h4>
                  내 용
                </h4>
                <div>
                  <div class="rating" data-star-rating="0">
                    <span class="star" data-rating="1">&#9733;</span>
                    <span class="star" data-rating="2">&#9733;</span>
                    <span class="star" data-rating="3">&#9733;</span>
                    <span class="star" data-rating="4">&#9733;</span>
                    <span class="star" data-rating="5">&#9733;</span>
                  </div>
                  <textarea id="review_textarea" name="reviewContent" placeholder="리뷰를 작성해주세요" style="resize:none;"></textarea>
                </div>
              </div>
              <div class="review_result" style="width:5%">
                <h4 id="hiddenHSR">
                  <div id="result" name="starRating" style="display: none;">별점: 0</div>
                  <div id="matchingNum" name="matchingNum" style="display: none;"></div>
                </h4>
                <a href="#" id="finish_button" class="button finish" style="margin-bottom:1rem;">등록</a>
                <a href="#" class="button cancel">취소</a>
              </div>
            </div>
            <ul class="reviews"></ul>
            <div class="page"></div>
          </div>




      </th:block>
    </div>


    <!-- Sidebar -->
    <div class="sidebar">

      <section>
        <h3 class="side_ranking">포인트 순위</h3>
        <div class="DietRanking">
          <div class="DietRanking_ranking">

          </div>
        </div>
        <h3 class="side_ranking">트레이너 구독 순위</h3>
        <div class="subRanking">
          <div class="subRanking_ranking">

          </div>
        </div>
      </section>

    </div>
  </div>
</section>

<!-- Footer -->
<th:block th:replace="~{layout/footer::footer}"></th:block>

<!-- Scripts -->
<script th:src="@{/assets/js/jquery.min.js}"></script>
<script th:src="@{/assets/js/jquery.dropotron.min.js}"></script>
<script th:src="@{/assets/js/jquery.scrollex.min.js}"></script>
<script th:src="@{/assets/js/browser.min.js}"></script>
<script th:src="@{/assets/js/breakpoints.min.js}"></script>
<script th:src="@{/assets/js/util.js}"></script>
<script th:src="@{/assets/js/main.js}"></script>

<script th:src="@{/assets/js/util_sub.js}"></script>
<script th:src="@{/assets/js/main_sub.js}"></script>

<script th:src="@{/assets/js/sidebar.js}"></script>
<script th:src="@{/assets/js/matching_u_t_matching.js}"></script>

<script th:src="@{/assets/js/review.js}"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:inline="javascript">
  const userId = /*[[${session.loginUser}]]*/'';
  const boardNum = document.getElementById('board').getAttribute('data-board-num');
  const starRating = document.getElementById('result').getAttribute('starRating')
  const reviews = $(".reviews")
  const page = $(".page")
  let nowpage = 0;


 $(document).ready(function () {
    // 서버에 특정 boardNum에 대한 utmatching 데이터 확인
    $.get(`/review/checkUtmatching/boardNum`, function (result) {
        if (result === 'exists') {
            // utmatching 데이터가 있으면 리뷰 작성 가능
            $('.regist').on('click', function (e) {
                e.preventDefault();

                // utmatching 데이터를 가져와서 div에 채워주기
                $.get(`/review/getUtmatchingNum/boardNum`, function (utmatchingNum) {
                    if (utmatchingNum !== 'not exists') {
                        // utmatching 데이터에서 userId 가져오기
                        $.get(`/review/getUtmatchingUserId/${utmatchingNum}`, function (utmatchingUserId) {
                            if (utmatchingUserId === userId) {
                                // userId가 일치하면 리뷰 작성 폼 보이기
                                $('.reviewForm').show();
                                $('.regist').hide();
                                $('#matchingNum').text(utmatchingNum).show();
                            } else {
                                // userId가 일치하지 않으면 알림 띄우기
                                alert('리뷰는 트레이너의 확인이 필요합니다. 매칭 진행 후 이용해주세요.');
                            }
                        });
                    } else {
                        // trainer_check가 'O'가 아니면 리뷰 작성 불가능
                        alert('리뷰는 트레이너의 확인이 필요합니다. 매칭 진행 후 이용해주세요.');
                        // 여기에서 다른 동작을 추가할 수 있습니다.
                    }
                });
            });
        } else {
            // utmatching 데이터가 없으면 리뷰 작성 불가능
            $('.regist').hide();
            // 알림 띄우기
            alert('리뷰는 트레이너의 확인이 필요합니다. 매칭 진행 후 이용해주세요.');
        }
    });

    // 기존 코드 - 리뷰 폼을 숨기고 리스트를 보여줌
    $(".reviewForm").hide();
    let nowpage = 1;
    showList(nowpage);

    // 리뷰 작성 버튼을 눌렀을 때 리뷰 폼을 보이게 함
    $(".regist").on("click", function (e) {
        e.preventDefault();
        $(".reviewForm").show();
        $(this).hide();
    });

    // 등록 버튼을 눌렀을 때 서버에 리뷰 등록 요청
    $(".finish").on("click", function (e) {
        e.preventDefault();
        let reviewContent = $("[name='reviewContent']").val();

        reviewService.add(
            {"matchingBoardNum": boardNum, "userId": loginUser, "reviewContent": reviewContent, "starRating": starRating, "matchingNum": matchingNum},
            function (result) {
                alert("등록!");
                showList(1);
            }
        );
    });
});

  function showList(pageNum){
      const boardNum = document.getElementById('board').getAttribute('data-board-num');
      reviewService.getList(
          {boardNum:boardNum, pageNum:pageNum||1},
          function(reviewCnt, list){
              let str = "";
              if(list == null || list.length == 0){
                  str += '<li class="noreview" style="clear:both;">등록된 댓글이 없습니다.</li>';
                  reviews.html(str);
                  return;
              }

              for(let i=0;i<list.length;i++){
                  //<li style="clear:both;" class="li3">
                  str += '<li style="clear:both;" class="li'+list[i].reviewNum+'">';
                  str += '<div style="display:inline; float:left; width:80%;">';
                  //<strong class="userId3">apple</strong>
                  str += '<strong class="userId'+list[i].reviewNum+'">'+list[i].userId+'</strong>';
                  //<p class="review3">댓글내용</p>
                  str += '<p class="review'+list[i].reviewNum+'">'+list[i].reviewContent+'</p>';
                  str += '</div><div style="text-align:right;">'
                  str += '<strong>'+reviewService.displayTime(list[i])+'</strong>'
                  if(list[i].userId == loginUser){
                      //<a href="3" class="modify">수정</a>
                      str += '<a href="'+list[i].reviewNum+'" class="modify">수정</a>';
                      str += '<a href="'+list[i].reviewNum+'" class="mfinish" style="display:none;">수정 완료</a>';
                      str += '<a href="'+list[i].reviewNum+'" class="remove">삭제</a>';
                  }
                  str += '</div></li>';
              }
              reviews.html(str);

              $(".remove").on("click",deleteReview);
              $(".modify").on("click",modifyReview);
              $(".mfinish").on("click",modifyReviewOk);

              showReviewPage(reviewCnt, pageNum);
          }
      )
  }


  function showReviewPage(reviewCnt, pageNum){
      let endPage = Math.ceil(pageNum/5)*5;
      let startPage = endPage - 4;

      let prev = startPage != 1;
      endPage = (endPage-1)*5 >= reviewCnt ? Math.ceil(reviewCnt/5) : endPage;
      let next = endPage*5 < reviewCnt ? true : false;

      let str = "";
      if(prev){
          //<a class="changePage" href="5"><code>&lt;</code></a>
          str += '<a class="changePage" href="'+(startPage-1)+'"><code>&lt;</code></a>';
      }
      for(let i=startPage;i<=endPage;i++){
          if(i == pageNum){
              //<code class="nowPage">7</code>
              str += '<code class="nowPage">'+i+'</code>';
          }
          else{
              //<a class="changePage" href="9"><code>9</code></a>
              str += '<a class="changePage" href="'+i+'"><code>'+i+'</code></a>';
          }
      }
      if(next){
          str += '<a class="changePage" href="'+(endPage+1)+'"><code>&gt;</code></a>';
      }

      page.html(str);

      $(".changePage").on("click",function(e){
          e.preventDefault();
          let target = $(this).attr("href");
          nowpage = parseInt(target);
          showList(nowpage);
          window.setTimeout(function(){
              window.scrollTo(0,document.body.scrollHeight)
          },10)
      })
  }

  function deleteReply(e){
      e.preventDefault();
      let reviewNum = $(this).attr("href");
      replyService.remove(
          reviewNum,
          function(result){
              if(result == "success"){
                  alert(reviewNum+"번 댓글 삭제 완료!");
                  showList(nowpage);
              }
          }
      )
  }
  let reviewFlag = false;
  function modifyReview(e){
      e.preventDefault();
      if(!reviewFlag){
          reviewFlag = true;
          let reviewNum = $(this).attr("href");
          const reviewTag = $(".review"+reviewNum);
          //<textarea class="3 mdf">댓글내용</textarea>
          reviewTag.html('<textarea class="'+reviewNum+' mdf">'+reviewTag.text()+'</textarea>')
          $(this).hide();
          $(this).next().show();
      }
      else{
          alert("수정중인 댓글이 있습니다!");
      }
  }
  function modifyReviewOk(e){
      e.preventDefault();
      reviewFlag = false;

      let reviewNum = $(this).attr("href");
      let reviewContent = $("."+reviewNum).val();

      if(reviewContent == ""){
          alert("수정할 댓글 내용을 입력하세요!");
          return;
      }
      replyService.modify(
          {reviewNum:reviewNum, reviewContent:reviewContent, boardNum:boardNum, userid:loginUser},
          function(result){
              if(result == "success"){
                  alert(replynum+"번 댓글 수정 완료!");
                  showList(nowpage);
              }
          }
      )
  }


  function modify(){
      const boardForm = document.boardForm;
      boardForm.setAttribute("action",/*[[@{/matching/matchinf)modify}]]*/'');
      boardForm.setAttribute("method","get");
      boardForm.submit();
  }

  $(".cancel").on("click",function(e){
      e.preventDefault();
      $(".reviewForm").hide();
      $(".regist").show();
      $("[name='reviewContent']").val("");
  })
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const stars = document.querySelectorAll(".rating .star");
    const resultDiv = document.getElementById("result");
    let selectedRating = 0;

    stars.forEach(function (star, index) {
      star.addEventListener("click", function () {
        selectedRating = parseInt(this.getAttribute("data-rating"));
        resultDiv.textContent = `별점: ${selectedRating}`;
        this.parentNode.setAttribute("data-star-rating", selectedRating);
        resetStars();
        highlightStars(index);
      });

      star.addEventListener("mouseover", function () {
        const rating = parseInt(this.getAttribute("data-rating"));
        highlightStars(rating - 1);
      });

      star.addEventListener("mouseout", function () {
        resetStars();
        highlightStars(selectedRating - 1);
      });
    });
  });

  function resetStars() {
    const stars = document.querySelectorAll(".rating .star");
    stars.forEach(function (star) {
      star.classList.remove("active");
    });
  }

  function highlightStars(index) {
    const stars = document.querySelectorAll(".rating .star");
    for (let i = 0; i <= index; i++) {
      stars[i].classList.add("active");
    }
  }


    $(document).ready(function () {
       $(".open").on("click", function (e) {
           e.preventDefault();
           var trainerId = '[[${trainerInfo.trainerId}]]';
           console.log("Trainer ID:", trainerId);
           sendTrainerIdToModal(trainerId);
           modalBox.classList.add("active");
       });
   });

</script>
</html>